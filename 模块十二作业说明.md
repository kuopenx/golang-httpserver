# 题目
把我们的 httpserver 服务以 Istio Ingress Gateway 的形式发布出来。以下是你需要考虑的几点：

- 如何实现安全保证；
- 七层路由规则；
- 考虑 open tracing 的接入。

## 操作步骤
### 安装istio
```bash
# istioctl version
client version: 1.14.3
control plane version: 1.14.3
data plane version: 1.14.3 (3 proxies)
```
创建namespace: httpserver，并打开istio注入：
```bash
# k create ns httpserver
# k label ns httpserver istio-injection=enabled
```
### 部署httpserver
以下为deployment和service的yaml文件内容：
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: httpserver
spec:
  replicas: 1
  selector:
    matchLabels:
      app: httpserver
  template:
    metadata:
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "80"
      labels:
        app: httpserver
    spec:
      imagePullSecrets:
        - name: regcred
      containers:
        - name: httpserver
          image: kuopenx/httpserver:v1.0-metrics
          ports:
            - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: httpserver
spec:
  ports:
    - name: http
      port: 80
      protocol: TCP
      targetPort: 80
  selector:
    app: httpserver
```
执行命令：
```bash
# k create -f httpserver-deployment-service.yaml -n httpserver
deployment.apps/httpserver created
service/httpserver created

# k get pod -n httpserver
NAME                         READY   STATUS    RESTARTS   AGE
httpserver-78d5866d6-jj78k   2/2     Running   0          9s

# k get deploy -n httpserver
NAME         READY   UP-TO-DATE   AVAILABLE   AGE
httpserver   1/1     1            1           108s

# k get svc -n httpserver
NAME         TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)   AGE
httpserver   ClusterIP   10.1.238.45   <none>        80/TCP    102s
```
### 部署gateway并且暴露服务
以下为VirtualService和Gateway的yaml文件内容：
```yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: httpsserver
spec:
  gateways:
    - httpsserver
  hosts:
    - httpsserver.kuopenx.io
  http:
    - match:
        - port: 443
      route:
        - destination:
            host: httpserver.httpserver.svc.cluster.local
            port:
              number: 80
---
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: httpsserver
spec:
  selector:
    istio: ingressgateway
  servers:
    - hosts:
        - httpsserver.kuopenx.io
      port:
        name: https-default
        number: 443
        protocol: HTTPS
      tls:
        mode: SIMPLE
        credentialName: httpserver-credential
```
执行命令：
```bash
# k create -f httpserver-virtualservice-gateway.yaml -n istio-system
virtualservice.networking.istio.io/httpsserver created
gateway.networking.istio.io/httpsserver created

# k get virtualservice -n istio-system
NAME          GATEWAYS          HOSTS                        AGE
httpsserver   ["httpsserver"]   ["httpsserver.kuopenx.io"]   30s

# k get gateway -n istio-system
NAME          AGE
httpsserver   46s
```
#### 自动签名：使用letsencrypt申请一张证书
在istio-system中配置issuer:
```yaml
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: letsencrypt-prod
spec:
  acme:
    email: guopeng.xue@foxmail.com
    preferredChain: ""
    privateKeySecretRef:
      name: letsencrypt-prod
    server: https://acme-v02.api.letsencrypt.org/directory
    solvers:
      - http01:
          ingress:
            class: istio
```
执行命令：
```bash
# k create -f istio-issuer.yaml -n istio-system
issuer.cert-manager.io/letsencrypt-prod created

# k get issuer -n istio-system
NAME               READY   AGE
letsencrypt-prod   True    54s
```
在istio-system中配置certificate：
```yaml
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: httpserver
spec:
  dnsNames:
    - httpsserver.kuopenx.io
  issuerRef:
    group: cert-manager.io
    kind: Issuer
    name: letsencrypt-prod
  secretName: httpserver-credential
  usages:
    - digital signature
    - key encipherment
```
执行命令：
```bash
# k create -f istio-cert.yaml -n istio-system
certificate.cert-manager.io/httpserver created

# k get cert -n istio-system
NAME         READY   SECRET                  AGE
httpserver   False   httpserver-credential   84m
```
#### 手动签发证书
```bash
# openssl req -x509 -sha256 -nodes -days 365 -newkey rsa:2048 -subj '/O=kuopenx Inc./CN=*.kuopenx.io' -keyout kuopenx.io.key -out kuopenx.io.crt
Generating a RSA private key
...............................+++++
..............+++++
writing new private key to 'kuopenx.io.key'
-----

# k create -n istio-system secret tls httpserver-credential --key=kuopenx.io.key --cert=kuopenx.io.crt
secret/httpserver-credential created

# k get secret httpserver-credential -n istio-system 
NAME                    TYPE                DATA   AGE
httpserver-credential   kubernetes.io/tls   2      72s
```
#### 验证
```bash
# curl --resolve httpsserver.kuopenx.io:443:10.1.19.73 https://httpsserver.kuopenx.io/hello -v -k
* Added httpsserver.kuopenx.io:443:10.1.19.73 to DNS cache
* Hostname httpsserver.kuopenx.io was found in DNS cache
*   Trying 10.1.19.73:443...
* TCP_NODELAY set
* Connected to httpsserver.kuopenx.io (10.1.19.73) port 443 (#0)
* ALPN, offering h2
* ALPN, offering http/1.1
* successfully set certificate verify locations:
*   CAfile: /etc/ssl/certs/ca-certificates.crt
  CApath: /etc/ssl/certs
* TLSv1.3 (OUT), TLS handshake, Client hello (1):
* TLSv1.3 (IN), TLS handshake, Server hello (2):
* TLSv1.3 (IN), TLS handshake, Encrypted Extensions (8):
* TLSv1.3 (IN), TLS handshake, Certificate (11):
* TLSv1.3 (IN), TLS handshake, CERT verify (15):
* TLSv1.3 (IN), TLS handshake, Finished (20):
* TLSv1.3 (OUT), TLS change cipher, Change cipher spec (1):
* TLSv1.3 (OUT), TLS handshake, Finished (20):
* SSL connection using TLSv1.3 / TLS_AES_256_GCM_SHA384
* ALPN, server accepted to use h2
* Server certificate:
*  subject: O=kuopenx Inc.; CN=*.kuopenx.io
*  start date: Aug 17 17:10:43 2022 GMT
*  expire date: Aug 17 17:10:43 2023 GMT
*  issuer: O=kuopenx Inc.; CN=*.kuopenx.io
*  SSL certificate verify result: self signed certificate (18), continuing anyway.
* Using HTTP2, server supports multi-use
* Connection state changed (HTTP/2 confirmed)
* Copying HTTP/2 data in stream buffer to connection buffer after upgrade: len=0
* Using Stream ID: 1 (easy handle 0x5581c064f2f0)
> GET /hello HTTP/2
> Host: httpsserver.kuopenx.io
> user-agent: curl/7.68.0
> accept: */*
> 
* TLSv1.3 (IN), TLS handshake, Newsession Ticket (4):
* TLSv1.3 (IN), TLS handshake, Newsession Ticket (4):
* old SSL session ID is stale, removing
* Connection state changed (MAX_CONCURRENT_STREAMS == 2147483647)!
< HTTP/2 200 
< date: Wed, 17 Aug 2022 17:20:12 GMT
< content-length: 6
< content-type: text/plain; charset=utf-8
< x-envoy-upstream-service-time: 640
< server: istio-envoy
< 
* Connection #0 to host httpsserver.kuopenx.io left intact
hello.
```